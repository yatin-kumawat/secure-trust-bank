<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Verify OTP | Secure Trust Bank</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: "class" };
  </script>
  <style>
    body {
      background: linear-gradient(to bottom right, #f0f9ff, #e6ffe6);
    }
    .dark body {
      background: #0f172a;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(14px);
      border: 1px solid rgba(200, 200, 255, 0.3);
    }
    .dark .glass-card {
      background: rgba(30, 41, 59, 0.7);
      border: 1px solid rgba(100, 116, 139, 0.4);
    }
  </style>

  <script>
    // üåô Auto theme setup (unchanged)
    if (localStorage.getItem("theme") === "dark") {
      document.documentElement.classList.add("dark");
    } else if (!localStorage.getItem("theme")) {
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      if (prefersDark) {
        document.documentElement.classList.add("dark");
        localStorage.setItem("theme", "dark");
      } else {
        localStorage.setItem("theme", "light");
      }
    }

    // Toggle theme
    function toggleTheme() {
      const isDark = document.documentElement.classList.toggle("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
    }
  </script>
</head>

<body class="relative min-h-screen flex items-center justify-center px-4 text-slate-800 dark:text-white transition duration-300">

  <!-- üåó Dark Mode Toggle -->
  <div class="absolute top-4 right-6 z-10">
    <button onclick="toggleTheme()" class="px-3 py-1 text-sm rounded-md border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-white hover:bg-slate-100 dark:hover:bg-slate-700 transition">
      Switch Theme
    </button>
  </div>

  <!-- üßæ Main Card -->
  <div class="glass-card w-full max-w-md p-8 rounded-2xl shadow-xl text-center relative">
    <!-- Back to Home -->
    <a href="/" class="absolute top-2 left-2 px-3 py-1 text-sm text-teal-600 rounded-md hover:bg-teal-100 hover:text-teal-800 transition">
      ‚Üê Home
    </a>

    <h1 class="text-2xl font-bold text-blue-700 dark:text-blue-300 mb-4">üîê OTP Verification</h1>

    <p class="mb-2 text-sm text-gray-700 dark:text-gray-300">
      We‚Äôve sent a one-time password (OTP) to your email. Enter it below to continue.
    </p>

    <!-- ‚úÖ OTP Entry Form -->
    <form method="POST" action="/verify_otp" class="space-y-4 mb-4">
      <input
        type="text"
        name="otp"
        maxlength="6"
        pattern="\d{6}"
        inputmode="numeric"
        required
        class="w-full px-4 py-2 border border-gray-300 rounded-lg text-black dark:bg-slate-700 dark:text-white dark:border-slate-600 focus:outline-none focus:ring-2 focus:ring-teal-500"
        placeholder="Enter OTP"
      />
      <button class="w-full bg-teal-600 text-white py-2 rounded-lg hover:bg-teal-700 transition">
        Verify OTP
      </button>

      {% if session['otp_attempts'] is defined and session['otp_attempts'] > 0 %}
      <div class="text-sm text-gray-600 dark:text-gray-300">
        {{ session['otp_attempts'] }}/3 OTP attempts used
      </div>
      {% endif %}
    </form>

    <!-- ‚è± Countdown Timer -->
    <p class="text-sm text-slate-600 dark:text-slate-300 mb-2">
      OTP expires in <span id="countdown" class="font-semibold text-indigo-600 dark:text-indigo-400">{{ countdown }}</span> seconds
    </p>

    <!-- üîÅ Resend OTP Form -->
    <form method="POST" action="/send_otp">
      <input type="hidden" name="acc_no" value="{{ session['acc_no'] }}" />
      <input type="hidden" name="pin" value="{{ session['pin'] }}" />

      <button id="resendBtn" class="w-full py-2 px-4 mt-1 rounded-xl border border-indigo-500 text-indigo-600 dark:text-indigo-400 disabled:opacity-50 disabled:cursor-not-allowed">
        Resend OTP
      </button>
    </form>

    <!-- ‚ö†Ô∏è Expired message (initially hidden) -->
    <p id="expiry-msg" class="text-sm mt-2 font-medium text-red-600 dark:text-red-400 hidden">
      ‚ö†Ô∏è OTP has expired. Please click "Resend OTP".
    </p>
  </div>

  <!-- ‚è≤Ô∏è Countdown Timer Script -->
  <script>
    let countdown = Number("{{ countdown | default(0) }}");
    const countdownSpan = document.getElementById('countdown');
    const resendBtn = document.getElementById('resendBtn');
    const expiryMsg = document.getElementById('expiry-msg');

    if (countdown > 0) {
      resendBtn.disabled = true;
      const timer = setInterval(() => {
        countdown--;
        countdownSpan.textContent = countdown;
        if (countdown <= 0) {
          clearInterval(timer);
          countdownSpan.textContent = "expired";
          resendBtn.disabled = false;
          expiryMsg.classList.remove('hidden');
        }
      }, 1000);
    } else {
      countdownSpan.textContent = "expired";
      resendBtn.disabled = false;
      expiryMsg.classList.remove('hidden');
    }
  </script>

  <!-- üîê Session Expiry Watcher (no change) -->
  <script src="{{ url_for('static', filename='js/session_checker.js') }}"></script>
  <script>
    setupSessionExpiry("{{ expires_at }}");
  </script>

</body>
</html>
